#!/usr/bin/env node

import { WhatsAppGateway } from '../dist/whatsapp/gateway.js';
import { clearAuth } from '../dist/whatsapp/session.js';
import { configExists, getAnthropicApiKey, getCurrentOrg, resolveModel } from '../dist/config.js';

// ---------------------------------------------------------------------------
// CLI argument parsing
// ---------------------------------------------------------------------------

const args = process.argv.slice(2);
const options = {
  model: undefined as string | undefined,
  allow: undefined as string[] | undefined,
  groups: false,
  authDir: undefined as string | undefined,
  reset: false,
  verbose: false,
};

for (let i = 0; i < args.length; i++) {
  switch (args[i]) {
    case '--model':
      options.model = args[++i];
      break;
    case '--allow':
      options.allow = args[++i]?.split(',').map(s => s.trim()).filter(Boolean);
      break;
    case '--groups':
      options.groups = true;
      break;
    case '--auth-dir':
      options.authDir = args[++i];
      break;
    case '--reset':
      options.reset = true;
      break;
    case '--verbose':
    case '-v':
      options.verbose = true;
      break;
    case '--help':
    case '-h':
      console.log(`
StateSet Response — WhatsApp Gateway

Usage: response-whatsapp [options]

Options:
  --model <name>     Model to use (sonnet, haiku, opus)       [default: config]
  --allow <phones>   Comma-separated allowlist of phone numbers
  --groups           Allow messages from group chats           [default: false]
  --auth-dir <path>  WhatsApp auth credential directory        [default: ~/.stateset/whatsapp-auth]
  --reset            Clear stored WhatsApp auth and re-scan QR
  --verbose, -v      Enable debug logging
  --help, -h         Show this help message

Examples:
  response-whatsapp                           Start with default settings
  response-whatsapp --model haiku             Use Claude Haiku
  response-whatsapp --allow 14155551234       Only accept from one number
  response-whatsapp --reset                   Re-authenticate with QR scan
`);
      process.exit(0);
  }
}

// ---------------------------------------------------------------------------
// Validation
// ---------------------------------------------------------------------------

if (!configExists()) {
  console.error('Error: No configuration found.');
  console.error('Run "response auth login" to set up your credentials first.');
  process.exit(1);
}

try {
  getAnthropicApiKey();
} catch (err) {
  console.error(`Error: ${err instanceof Error ? err.message : err}`);
  process.exit(1);
}

try {
  getCurrentOrg();
} catch (err) {
  console.error(`Error: ${err instanceof Error ? err.message : err}`);
  process.exit(1);
}

if (options.model) {
  const resolved = resolveModel(options.model);
  if (!resolved) {
    console.error(`Error: Unknown model "${options.model}". Valid: sonnet, haiku, opus`);
    process.exit(1);
  }
}

// ---------------------------------------------------------------------------
// Reset auth if requested
// ---------------------------------------------------------------------------

if (options.reset) {
  clearAuth(options.authDir);
  console.log('WhatsApp auth credentials cleared. You will need to scan the QR code again.');
}

// ---------------------------------------------------------------------------
// Banner
// ---------------------------------------------------------------------------

const { orgId } = getCurrentOrg();

console.log(`
╔═══════════════════════════════════════════════════╗
║       StateSet Response — WhatsApp Gateway        ║
╠═══════════════════════════════════════════════════╣
║  Organization: ${orgId.padEnd(34)}║
║  Model:        ${(options.model ?? 'default').padEnd(34)}║
║  Groups:       ${(options.groups ? 'allowed' : 'disabled').padEnd(34)}║
${options.allow ? `║  Allowlist:    ${options.allow.length + ' number(s)'.padEnd(30)}     ║\n` : ''}╚═══════════════════════════════════════════════════╝
`);

// ---------------------------------------------------------------------------
// Start gateway
// ---------------------------------------------------------------------------

const gateway = new WhatsAppGateway({
  model: options.model,
  allowList: options.allow,
  allowGroups: options.groups,
  authDir: options.authDir,
  verbose: options.verbose,
});

const shutdown = async () => {
  console.log('\nShutting down gracefully...');
  await gateway.stop();
  process.exit(0);
};

process.on('SIGINT', shutdown);
process.on('SIGTERM', shutdown);

gateway.start().catch(err => {
  console.error('Failed to start gateway:', err instanceof Error ? err.message : err);
  process.exit(1);
});
