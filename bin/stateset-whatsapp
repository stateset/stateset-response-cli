#!/usr/bin/env node

import { WhatsAppGateway } from '../dist/whatsapp/gateway.js';
import { clearAuth } from '../dist/whatsapp/session.js';
import {
  configExists,
  getAnthropicApiKey,
  getCurrentOrg,
  resolveModelOrThrow,
} from '../dist/config.js';
import { logger } from '../dist/lib/logger.js';
import { installGlobalErrorHandlers } from '../dist/lib/errors.js';
import { createRequire } from 'node:module';
import { parseWhatsAppArgs } from '../dist/cli/gateway-args.js';

installGlobalErrorHandlers();
const require = createRequire(import.meta.url);
const pkg = require('../package.json') as { version?: string };

// ---------------------------------------------------------------------------
// CLI argument parsing
// ---------------------------------------------------------------------------

const args = process.argv.slice(2);
let options: {
  model: string | undefined;
  allow: string[] | undefined;
  groups: boolean;
  selfChat: boolean;
  authDir: string | undefined;
  reset: boolean;
  verbose: boolean;
};

try {
  const parsed = parseWhatsAppArgs(args);
  if (parsed.showVersion) {
    console.log(pkg.version || '0.0.0');
    process.exit(0);
  }
  if (parsed.showHelp) {
    console.log(`
StateSet Response — WhatsApp Gateway

Usage: response-whatsapp [options]

Options:
  --model <name>, -m  Model to use (sonnet, haiku, opus or full model ID) [default: config]
  --allow <phones>   Comma-separated allowlist of phone numbers
  --groups           Allow messages from group chats           [default: false]
  --self-chat        Only respond to messages you send to yourself
  --auth-dir <path>  WhatsApp auth credential directory        [default: ~/.stateset/whatsapp-auth]
  --reset            Clear stored WhatsApp auth and re-scan QR
  --version, -V      Show this version
  --verbose, -v      Enable debug logging
  --help, -h         Show this help message

Examples:
  response-whatsapp                           Start with default settings
  response-whatsapp --model haiku             Use Claude Haiku
  response-whatsapp --allow 14155551234       Only accept from one number
  response-whatsapp --self-chat               Only respond to your self-chat
  response-whatsapp --reset                   Re-authenticate with QR scan
`);
`);
    process.exit(0);
  }
  options = {
    model: parsed.model,
    allow: parsed.allowList,
    groups: parsed.allowGroups,
    selfChat: parsed.selfChatOnly,
    authDir: parsed.authDir,
    reset: parsed.resetAuth,
    verbose: parsed.verbose,
  };
} catch (err) {
  console.error(`Error: ${err instanceof Error ? err.message : err}`);
  console.error('Run "response-whatsapp --help" for supported options.');
  process.exit(1);
}

// ---------------------------------------------------------------------------
// Logger
// ---------------------------------------------------------------------------

logger.configure({ level: options.verbose ? 'debug' : 'info' });

// ---------------------------------------------------------------------------
// Validation
// ---------------------------------------------------------------------------

if (!configExists()) {
  console.error('Error: No configuration found.');
  console.error('Run "response auth login" to set up your credentials first.');
  process.exit(1);
}

try {
  getAnthropicApiKey();
} catch (err) {
  console.error(`Error: ${err instanceof Error ? err.message : err}`);
  process.exit(1);
}

let orgId = '';
try {
  orgId = getCurrentOrg().orgId;
} catch (err) {
  console.error(`Error: ${err instanceof Error ? err.message : err}`);
  process.exit(1);
}

if (options.model) {
  try {
    options.model = resolveModelOrThrow(options.model, 'valid');
  } catch (err) {
    console.error(`Error: ${err instanceof Error ? err.message : err}`);
    process.exit(1);
  }
}

// ---------------------------------------------------------------------------
// Reset auth if requested
// ---------------------------------------------------------------------------

if (options.reset) {
  try {
    clearAuth(options.authDir);
    console.log('WhatsApp auth credentials cleared. You will need to scan the QR code again.');
  } catch (err) {
    console.error(
      `Error: Unable to clear WhatsApp auth credentials (${err instanceof Error ? err.message : err})`,
    );
    process.exit(1);
  }
}

// ---------------------------------------------------------------------------
// Banner
// ---------------------------------------------------------------------------

console.log(`
╔═══════════════════════════════════════════════════╗
║       StateSet Response — WhatsApp Gateway        ║
╠═══════════════════════════════════════════════════╣
║  Organization: ${orgId.padEnd(34)}║
║  Model:        ${(options.model ?? 'default').padEnd(34)}║
║  Groups:       ${(options.groups ? 'allowed' : 'disabled').padEnd(34)}║
║  Self chat:    ${(options.selfChat ? 'enabled' : 'disabled').padEnd(34)}║
${options.allow ? `║  Allowlist:    ${options.allow.length + ' number(s)'.padEnd(30)}     ║\n` : ''}╚═══════════════════════════════════════════════════╝
`);

// ---------------------------------------------------------------------------
// Start gateway
// ---------------------------------------------------------------------------

const gateway = new WhatsAppGateway({
  model: options.model,
  allowList: options.allow,
  allowGroups: options.groups,
  selfChatOnly: options.selfChat,
  authDir: options.authDir,
  verbose: options.verbose,
});

let isShuttingDown = false;
const shutdown = async () => {
  if (isShuttingDown) return;
  isShuttingDown = true;
  console.log('\nShutting down gracefully...');
  try {
    await gateway.stop();
  } catch (err) {
    console.error(`Error during shutdown: ${err instanceof Error ? err.message : String(err)}`);
  } finally {
    process.exit(0);
  }
};

process.once('SIGINT', shutdown);
process.once('SIGTERM', shutdown);

gateway.start().catch(err => {
  console.error('Failed to start gateway:', err instanceof Error ? err.message : err);
  process.exit(1);
});
